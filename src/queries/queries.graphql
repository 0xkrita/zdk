fragment TokenContractInfo on TokenContract {
  name
  network
  description
  collectionAddress
  symbol
  chain
}

fragment FullMedia on TokenContentMedia {
  size
  url
  size
  mimeType
  mimeType
  mediaEncoding {
    large
    poster
    preview
    thumbnail
  }
}

fragment PriceSummary on PriceAtTime {
  blockNumber
  ethPrice {
    decimal
    raw
  }
  nativePrice {
    decimal
    raw
    currency {
      address
      decimals
      name
    }
  }
  usdcPrice {
    decimal
    raw
  }
}

fragment MintDetails on MintInfo {
  price {
    ...PriceSummary
  }
  originatorAddress
  toAddress
  mintContext {
    ...TransactionDetails
  }
}

fragment TransactionDetails on TransactionInfo {
  blockNumber
  blockTimestamp
  transactionHash
  logIndex
}

fragment SaleInfo on Sale {
  saleContractAddress
  transactionInfo {
    ...TransactionDetails
  }
  buyerAddress
  collectionAddress
  # saleType{ SaleEventType!}
  price {
    ...PriceSummary
  }
  sellerAddress
  tokenId
}

fragment SaleDetails on SaleConnection {
  totalCount
  nodes {
    ...SaleInfo
  }
}

fragment V2AuctionMarketProperties on V2Auction {
  __typename
  firstBidTime
  highestBidder
  curator
  collectionAddress
  curatorFeePercentage
  status
  tokenId
  auctionCurrency
  duration
  estimatedExpirationTime
  auctionStatus: status
  tokenOwner
  address
  auctionId
  approved
  reservePrice {
    ...PriceSummary
  }
  highestBidPrice {
    ...PriceSummary
  }
}

fragment V3AskProperties on V3Ask {
  __typename
  buyer
  finder
  findersFeeBps
  sellerFundsRecipient
  askStatus: status
  seller
  address
  askCurrency
  collectionAddress
  askPrice {
    ...PriceSummary
  }
}

fragment MarketPropertiesFull on MarketProperties {
  # TODO: iain support v1 liquidity?
  ...V2AuctionMarketProperties
  ...V3AskProperties
}

fragment MarketInfo on Market {
  collectionAddress
  marketAddress
  marketType
  transactionInfo {
    ...TransactionDetails
  }
  price {
    ...PriceSummary
  }
  status
  networkInfo {
    chain
    network
  }
}

fragment MarketDetails on Market {
  properties {
    ...MarketPropertiesFull
  }
}

fragment TokenInfo on Token {
  tokenId
  tokenContract {
    ...TokenContractInfo
  }
  mintInfo {
    ...MintDetails
  }
  collectionAddress
  lastRefreshTime
  owner
  name
  description
  image {
    ...FullMedia
  }
  content {
    ...FullMedia
  }
}

fragment TokenDetails on Token {
  metadata

  tokenUrl
  tokenUrlMimeType

  attributes {
    traitType
    value
    displayType
  }
}

fragment CollectionInfo on Collection {
  address
  description
  name
  symbol
  totalSupply
}

fragment CollectionDetails on Collection {
  attributes {
    traitType
    valueMetrics {
      count
      percent
      value
    }
  }
}

fragment PageInfoDefault on PageInfo {
  limit
  offset
}

query collections(
  $networks: [NetworkInput!]!
  $where: CollectionsQueryInput!
  $pagination: PaginationInput!
  $sort: CollectionSortKeySortInput!
  $includeFullDetails: Boolean!
) {
  collections(where: $where, networks: $networks, pagination: $pagination, sort: $sort) {
    totalCount
    pageInfo {
      limit
      offset
    }
    nodes {
      ...CollectionInfo
      ...CollectionDetails @include(if: $includeFullDetails)
    }
  }
}

query tokens(
  $networks: [NetworkInput!]!
  $where: TokensQueryInput
  $filter: TokensQueryFilter
  $pagination: PaginationInput!
  $sort: TokenSortKeySortInput!
  $includeFullDetails: Boolean!
) {
  tokens(
    where: $where
    networks: $networks
    pagination: $pagination
    sort: $sort
    filter: $filter
  ) {
    totalCount
    pageInfo {
      limit
      offset
    }
    nodes {
      ...TokenInfo
      ...TokenDetails @include(if: $includeFullDetails)
    }
  }
}
query tokenMarkets(
  $networks: [NetworkInput!]!
  $where: TokenMarketsQueryInput!
  $pagination: PaginationInput!
  $filter: TokenMarketsFilterInput
  $sort: TokenMarketSortKeySortInput!
  $includeFullDetails: Boolean!
  $includeSalesHistory: Boolean!
) {
  # this returns all associated markets
  tokenMarkets(
    where: $where
    networks: $networks
    filter: $filter
    pagination: $pagination
    sort: $sort
  ) {
    nodes {
      markets {
        ...MarketInfo
        ...MarketDetails @include(if: $includeFullDetails)
      }
      token {
        ...TokenInfo
        ...TokenDetails @include(if: $includeFullDetails)
      }
      sales(
        pagination: { limit: 10, offset: 0 }
        sort: { sortKey: TIME, sortDirection: DESC }
      ) {
        ...SaleDetails @include(if: $includeSalesHistory)
      }
    }
    pageInfo {
      ...PageInfoDefault
    }
  }
}

query aggregateStats(
  $networks: [NetworkInput!]!
  $where: AggregateStatQueryInput!
  $statType: StatType!
) {
  aggregateStat(networks: $networks, where: $where, statType: $statType) {
    stat {
      ... on FloatValue {
        floatValue: value
        unit
      }
      ... on IntValue {
        intValue: value
        unit
      }
    }
  }
}

query aggregateAttributes(
  $networks: [NetworkInput!]!
  $where: AggregateAttributesQueryInput!
) {
  aggregateAttributes(networks: $networks, where: $where) {
    traitType
    valueMetrics {
      value
      count
      percent
    }
  }
}
